<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Settings - Manage your profile and preferences on MovieNightPlanner.">
    <meta property="og:title" content="Settings - MovieNightPlanner">
    <meta property="og:description" content="Manage your profile and preferences on MovieNightPlanner.">
    <meta property="og:type" content="website">
    <link rel="canonical" href="Setting.html">
    <title>Settings - MovieNightPlanner</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/pages/settings.css">
</head>
<body>
    <header class="header">
        <a href="website.html" class="logo-link" aria-label="MovieNightPlanner home">
            <h1 class="logo">MovieNightPlanner</h1>
        </a>
        <nav class="main-nav" aria-label="Main navigation">
            <a href="website.html">Home</a>
            <a href="Binge_Bank.html">Binge Bank</a>
            <a href="Stream_team.html">Stream Team</a>
            <a href="Friends.html">Friends</a>
            <a href="heads_up.html">Heads Up</a>
            <a href="Setting.html">Settings</a>
        </nav>
        <div class="nav-auth">
            <a href="Log_In.html" id="loginLink" class="nav-auth-btn nav-auth-ghost">Log In</a>
            <a href="Sign_Up.html" id="signUpLink" class="nav-auth-btn nav-auth-primary">Sign Up</a>
            <button type="button" id="logoutLink" class="nav-auth-btn nav-auth-primary" style="display:none;">Sign Out</button>
        </div>
    </header>

    <main class="se-main">
        <section class="se-header card" data-animate>
            <h2>Settings</h2>
            <p>Control your profile, notifications, and account safety.</p>
        </section>

        <section class="status-messages" data-animate>
            <div class="success-message" id="successMessage" aria-live="polite"></div>
            <div class="error-message" id="errorMessage" aria-live="assertive"></div>
        </section>

        <section id="content" class="settings-content" data-animate></section>
    </main>

    <script src="app.js"></script>
    <script>
        const content = document.getElementById('content');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        let userProfile = null;

        function showSuccess(message) {
            setStatusMessage(successMessage, errorMessage, message, 'success', 3000);
        }

        function showError(message) {
            setStatusMessage(successMessage, errorMessage, message, 'error');
        }

        function hideMessages() {
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
        }

        async function loadUserProfile() {
            userProfile = await apiCall('/users/profile');
            return userProfile;
        }

        async function loadSettings() {
            if (!currentUser) {
                content.innerHTML = `
                    <div class="login-prompt card">
                        <h3>Please log in to access settings</h3>
                        <p>Manage your profile and account preferences.</p>
                        <p><a href="Log_In.html">Log In</a> or <a href="Sign_Up.html">Sign Up</a></p>
                    </div>
                `;
                return;
            }

            try {
                await loadUserProfile();
                content.innerHTML = `
                    <section class="settings-section card">
                        <h3 class="section-title">Profile Information</h3>
                        <form id="profileForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="name">Name</label>
                                    <input type="text" id="name" value="${escapeHtml(userProfile.name)}" required>
                                </div>
                                <div class="form-group">
                                    <label for="email">Email</label>
                                    <input type="email" id="email" value="${escapeHtml(userProfile.email)}" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="bio">Bio</label>
                                <textarea id="bio" rows="3" placeholder="Tell your friends what you watch">${escapeHtml(userProfile.bio)}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="favoriteGenres">Favorite Genres</label>
                                <input type="text" id="favoriteGenres" value="${escapeHtml(userProfile.favorite_genres)}" placeholder="Action, Comedy, Drama">
                            </div>
                            <button type="submit" class="btn btn-primary" id="profileSaveBtn">
                                <span id="profileBtnText">Save Profile</span>
                            </button>
                        </form>
                    </section>

                    <section class="settings-section card">
                        <h3 class="section-title">Notification Preferences</h3>
                        <form id="preferencesForm">
                            <div class="preference-item">
                                <span class="preference-label">Email notifications for movie nights</span>
                                <label class="toggle-switch"><input type="checkbox" id="emailNotif" ${userProfile.email_notifications ? 'checked' : ''}><span class="toggle-slider"></span></label>
                            </div>
                            <div class="preference-item">
                                <span class="preference-label">Group invitation notifications</span>
                                <label class="toggle-switch"><input type="checkbox" id="groupNotif" ${userProfile.group_notifications ? 'checked' : ''}><span class="toggle-slider"></span></label>
                            </div>
                            <div class="preference-item">
                                <span class="preference-label">Vote reminders</span>
                                <label class="toggle-switch"><input type="checkbox" id="voteNotif" ${userProfile.vote_notifications ? 'checked' : ''}><span class="toggle-slider"></span></label>
                            </div>
                            <div class="preference-item">
                                <span class="preference-label">Public profile</span>
                                <label class="toggle-switch"><input type="checkbox" id="publicProfile" ${userProfile.public_profile ? 'checked' : ''}><span class="toggle-slider"></span></label>
                            </div>
                            <button type="submit" class="btn btn-primary" id="prefSaveBtn">
                                <span id="prefBtnText">Save Preferences</span>
                            </button>
                        </form>
                    </section>

                    <section class="settings-section card">
                        <h3 class="section-title">Theme</h3>
                        <p class="theme-copy">Choose a default appearance for this browser.</p>
                        <div class="theme-options">
                            <button class="theme-card" data-theme-choice="dark" type="button">Dark</button>
                            <button class="theme-card" data-theme-choice="light" type="button">Light</button>
                        </div>
                    </section>

                    <section class="settings-section danger-zone card">
                        <h3 class="section-title">Danger Zone</h3>
                        <p>This action signs you out and hides your account profile.</p>
                        <button id="deleteAccountBtn" class="btn btn-danger" type="button">Delete Account</button>
                    </section>
                `;

                document.getElementById('profileForm').addEventListener('submit', saveProfile);
                document.getElementById('preferencesForm').addEventListener('submit', savePreferences);
                document.getElementById('deleteAccountBtn').addEventListener('click', deleteAccount);

                const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
                document.querySelectorAll('.theme-card').forEach((btn) => {
                    if (btn.dataset.themeChoice === currentTheme) {
                        btn.classList.add('active');
                    }
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.theme-card').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        const selectedTheme = btn.dataset.themeChoice;
                        if (selectedTheme && typeof applyTheme === 'function') {
                            applyTheme(selectedTheme);
                            showSuccess(`Theme set to ${selectedTheme}`);
                        }
                    });
                });
            } catch (error) {
                if (error.status === 401 || (error.message && (error.message.includes('Not authenticated') || error.message.includes('401')))) {
                    currentUser = null;
                    localStorage.removeItem('currentUser');
                    updateAuthUI();
                    content.innerHTML = `
                        <div class="login-prompt card">
                            <h3>Session expired â€” please log in again</h3>
                            <p>Manage your profile and account preferences.</p>
                            <p><a href="Log_In.html">Log In</a> or <a href="Sign_Up.html">Sign Up</a></p>
                        </div>
                    `;
                } else {
                    showError('Failed to load settings. Please try again.');
                    content.innerHTML = '<div class="login-prompt card"><h3>Error loading settings</h3><p>Please refresh and retry.</p><button class="btn btn-primary" onclick="loadSettings()">Retry</button></div>';
                }
            }
        }

        async function saveProfile(e) {
            e.preventDefault();
            hideMessages();

            const profileSaveBtn = document.getElementById('profileSaveBtn');
            const profileBtnText = document.getElementById('profileBtnText');
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const bio = document.getElementById('bio').value.trim();
            const favoriteGenres = document.getElementById('favoriteGenres').value.trim();

            if (!name || !email) {
                showError('Name and email are required');
                return;
            }

            profileSaveBtn.disabled = true;
            profileBtnText.textContent = 'Saving...';

            try {
                const result = await apiCall('/users/profile', 'PUT', {
                    name,
                    email,
                    bio,
                    favorite_genres: favoriteGenres
                });

                currentUser.name = result.name || name;
                currentUser.email = result.email || email;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                userProfile = { ...userProfile, name, email, bio, favorite_genres: favoriteGenres };
                showSuccess('Profile updated successfully');
                setActiveNavLink();
            } catch (error) {
                showError(getErrorMessage(error, 'Failed to update profile'));
            } finally {
                profileSaveBtn.disabled = false;
                profileBtnText.textContent = 'Save Profile';
            }
        }

        async function savePreferences(e) {
            e.preventDefault();
            hideMessages();

            const prefSaveBtn = document.getElementById('prefSaveBtn');
            const prefBtnText = document.getElementById('prefBtnText');

            const emailNotifications = document.getElementById('emailNotif').checked;
            const groupNotifications = document.getElementById('groupNotif').checked;
            const voteNotifications = document.getElementById('voteNotif').checked;
            const publicProfile = document.getElementById('publicProfile').checked;

            prefSaveBtn.disabled = true;
            prefBtnText.textContent = 'Saving...';

            try {
                await apiCall('/users/preferences', 'PUT', {
                    email_notifications: emailNotifications,
                    group_notifications: groupNotifications,
                    vote_notifications: voteNotifications,
                    public_profile: publicProfile
                });

                userProfile = {
                    ...userProfile,
                    email_notifications: emailNotifications,
                    group_notifications: groupNotifications,
                    vote_notifications: voteNotifications,
                    public_profile: publicProfile
                };

                showSuccess('Preferences updated successfully');
            } catch (error) {
                showError(getErrorMessage(error, 'Failed to update preferences'));
            } finally {
                prefSaveBtn.disabled = false;
                prefBtnText.textContent = 'Save Preferences';
            }
        }

        async function deleteAccount() {
            hideMessages();
            if (!confirm('Delete your account? This cannot be undone.')) return;

            const deleteBtn = document.getElementById('deleteAccountBtn');
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'Deleting...';

            try {
                await apiCall('/users/profile', 'DELETE');
                localStorage.removeItem('currentUser');
                showSuccess('Account deleted. Redirecting...');
                setTimeout(() => {
                    window.location.href = 'website.html';
                }, 1000);
            } catch (error) {
                showError(getErrorMessage(error, 'Failed to delete account'));
                deleteBtn.disabled = false;
                deleteBtn.textContent = 'Delete Account';
            }
        }

        (async () => {
            await ensureAuthState();
            loadSettings();
        })();
    </script>
</body>
</html>
