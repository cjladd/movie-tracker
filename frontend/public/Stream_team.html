<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Stream Team - Create and manage movie watching groups with your friends on MovieNightPlanner.">
    <meta property="og:title" content="Stream Team - MovieNightPlanner">
    <meta property="og:description" content="Create and manage movie watching groups with your friends on MovieNightPlanner.">
    <meta property="og:type" content="website">
    <link rel="canonical" href="Stream_team.html">
    <title>Stream Team - MovieNightPlanner</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/pages/stream-team.css">
</head>
<body>
    <header class="header">
        <h1 class="logo">MovieNightPlanner</h1>
        <nav class="main-nav" aria-label="Main navigation">
            <a href="website.html">Home</a>
            <a href="Binge_Bank.html">Binge Bank</a>
            <a href="Stream_team.html">Stream Team</a>
            <a href="Friends.html">Friends</a>
            <a href="heads_up.html">Heads Up</a>
            <a href="Setting.html">Settings</a>
            <a href="Log_In.html" id="loginLink">Log In</a>
            <a href="Sign_Up.html" id="signUpLink">Sign Up</a>
            <a href="#" id="logoutLink" style="display:none;">Sign Out</a>
        </nav>
    </header>

    <main class="st-main">
        <section class="st-header card" data-animate>
            <div>
                <h2>Your Stream Teams</h2>
                <p>Create groups, vote on watchlists, and schedule nights from one workspace.</p>
            </div>
            <button class="btn btn-primary" id="createGroupBtn" type="button">Create New Group</button>
        </section>

        <section id="content" data-animate></section>

        <section id="groupDetail" class="group-detail card" data-animate>
            <div class="group-detail-header">
                <h3 class="group-detail-title" id="groupDetailTitle">Group Name</h3>
                <button class="btn btn-secondary" id="backToGroups" type="button">Back to Groups</button>
            </div>

            <div class="detail-tabs">
                <button class="detail-tab active" type="button" data-tab="members">Members</button>
                <button class="detail-tab" type="button" data-tab="watchlist">Watchlist</button>
                <button class="detail-tab" type="button" data-tab="movie-nights">Movie Nights</button>
            </div>

            <div id="membersTab" class="tab-content active">
                <div class="success-message" id="memberSuccess"></div>
                <div class="error-message" id="memberError"></div>

                <div class="add-member-form card">
                    <h4>Invite Member</h4>
                    <div class="add-member-row">
                        <label for="memberEmailInput" class="sr-only">Member email</label>
                        <input type="email" id="memberEmailInput" placeholder="friend@example.com">
                        <button class="btn btn-primary" id="addMemberBtn" type="button">Invite</button>
                    </div>
                </div>

                <ul class="members-list" id="membersList"></ul>
            </div>

            <div id="watchlistTab" class="tab-content">
                <div class="watchlist-header">
                    <h4>Group Watchlist</h4>
                    <a href="Binge_Bank.html" class="btn btn-primary">Add Movies</a>
                </div>
                <div class="watchlist-voting-grid" id="watchlistVotingGrid"></div>
            </div>

            <div id="movieNightsTab" class="tab-content">
                <div class="success-message" id="movieNightSuccess"></div>
                <div class="error-message" id="movieNightError"></div>

                <div class="create-movie-night-form card">
                    <h4>Schedule Movie Night</h4>
                    <div class="form-group">
                        <label for="movieNightDate">Date & Time</label>
                        <input type="datetime-local" id="movieNightDate">
                    </div>
                    <div class="form-group">
                        <label for="chosenMovie">Movie (optional)</label>
                        <select id="chosenMovie">
                            <option value="">Select a movie from watchlist...</option>
                        </select>
                    </div>
                    <button id="createMovieNightBtn" class="btn btn-primary" type="button">Schedule Movie Night</button>
                </div>

                <ul class="movie-nights-list" id="movieNightsList"></ul>
            </div>
        </section>
    </main>

    <div id="createModal" class="modal" style="display:none;">
        <div class="modal-content">
            <button class="modal-close close" aria-label="Close" type="button">x</button>
            <h3>Create a New Group</h3>
            <div class="error-message" id="createGroupError"></div>
            <label for="groupNameInput" class="sr-only">Group name</label>
            <input type="text" id="groupNameInput" placeholder="Enter group name" maxlength="100">
            <button id="confirmCreateBtn" class="btn btn-primary" type="button">Create Group</button>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let currentGroupId = null;

        const content = document.getElementById('content');
        const createGroupBtn = document.getElementById('createGroupBtn');
        const createModal = document.getElementById('createModal');
        const groupDetail = document.getElementById('groupDetail');
        const groupNameInput = document.getElementById('groupNameInput');
        const confirmCreateBtn = document.getElementById('confirmCreateBtn');
        const backToGroups = document.getElementById('backToGroups');

        const groupDetailTitle = document.getElementById('groupDetailTitle');
        const membersList = document.getElementById('membersList');
        const watchlistVotingGrid = document.getElementById('watchlistVotingGrid');
        const movieNightsList = document.getElementById('movieNightsList');

        document.addEventListener('DOMContentLoaded', () => {
            loadGroups();
            setupEventListeners();
        });

        function normalizeCollection(result) {
            if (Array.isArray(result)) return result;
            if (result && Array.isArray(result.data)) return result.data;
            return [];
        }

        function setupEventListeners() {
            document.querySelectorAll('.close').forEach((closeBtn) => {
                closeBtn.addEventListener('click', () => {
                    closeBtn.closest('.modal').style.display = 'none';
                });
            });

            window.addEventListener('click', (event) => {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });

            createGroupBtn.addEventListener('click', () => {
                if (!checkAuth()) {
                    window.location.href = 'Log_In.html';
                    return;
                }
                createModal.style.display = 'flex';
                groupNameInput.value = '';
                groupNameInput.focus();
            });

            confirmCreateBtn.addEventListener('click', handleCreateGroup);
            groupNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleCreateGroup();
            });

            backToGroups.addEventListener('click', () => {
                groupDetail.classList.remove('active');
                loadGroups();
            });

            document.querySelectorAll('.detail-tab').forEach((tab) => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            document.getElementById('addMemberBtn').addEventListener('click', handleAddMember);
            document.getElementById('memberEmailInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleAddMember();
            });

            document.getElementById('createMovieNightBtn').addEventListener('click', handleCreateMovieNight);
        }

        async function loadGroups() {
            if (!currentUser) {
                content.innerHTML = `
                    <div class="login-prompt card">
                        <h3>Please log in to view your groups</h3>
                        <p>Join or create movie groups with your friends.</p>
                        <p><a href="Log_In.html">Log In</a> or <a href="Sign_Up.html">Sign Up</a></p>
                    </div>
                `;
                createGroupBtn.style.display = 'none';
                return;
            }

            createGroupBtn.style.display = '';

            try {
                const groups = normalizeCollection(await getGroups());
                if (groups.length === 0) {
                    content.innerHTML = `
                        <div class="empty-state card">
                            <h3>No groups yet</h3>
                            <p>Create your first group to start planning movie nights.</p>
                        </div>
                    `;
                    return;
                }
                displayGroups(groups);
            } catch (error) {
                content.innerHTML = '<div class="empty-state card"><h3>Error loading groups</h3><p>Please refresh and try again.</p></div>';
            }
        }

        function displayGroups(groups) {
            const grid = document.createElement('div');
            grid.className = 'groups-grid';

            groups.forEach((group) => {
                const card = document.createElement('article');
                card.className = 'group-card card animate-fade-in-up';
                card.innerHTML = `
                    <div class="group-name">${escapeHtml(group.group_name)}</div>
                    <div class="group-info">
                        Created: ${formatDate(group.created_at)}<br>
                        Creator: ${escapeHtml(group.creator_name || 'Unknown')}
                    </div>
                    <div class="group-actions">
                        <button class="btn btn-secondary js-members" type="button">View Members</button>
                        <button class="btn btn-primary js-enter" type="button">Enter Group</button>
                    </div>
                `;

                card.querySelector('.js-members').addEventListener('click', () => enterGroup(group.group_id, group.group_name));
                card.querySelector('.js-enter').addEventListener('click', () => enterGroup(group.group_id, group.group_name));
                grid.appendChild(card);
            });

            content.innerHTML = '';
            content.appendChild(grid);
        }

        async function handleCreateGroup() {
            const groupName = groupNameInput.value.trim();
            const errorDiv = document.getElementById('createGroupError');
            if (!groupName) {
                showError(errorDiv, 'Please enter a group name');
                return;
            }

            try {
                await createGroup(groupName);
                createModal.style.display = 'none';
                showSuccess(null, 'Group created successfully');
                loadGroups();
            } catch (error) {
                showError(errorDiv, error.message || 'Failed to create group');
            }
        }

        async function enterGroup(groupId, groupName) {
            currentGroupId = groupId;
            groupDetailTitle.textContent = groupName;
            groupDetail.classList.add('active');
            await loadMembers();
            await loadWatchlistMovies();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.detail-tab').forEach((tab) => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            document.querySelectorAll('.tab-content').forEach((tab) => {
                tab.classList.remove('active');
            });

            const targetTab = document.getElementById(`${tabName}Tab`);
            if (targetTab) targetTab.classList.add('active');

            if (tabName === 'members') loadMembers();
            if (tabName === 'watchlist') loadWatchlist();
            if (tabName === 'movie-nights') loadMovieNights();
        }

        async function loadMembers() {
            if (!currentGroupId) return;
            try {
                const members = normalizeCollection(await getGroupMembers(currentGroupId));
                if (members.length === 0) {
                    membersList.innerHTML = '<li class="empty-state card">No members yet</li>';
                    return;
                }

                membersList.innerHTML = members.map((member) => `
                    <li class="member-item card">
                        <div class="member-info">
                            <div class="member-name">${escapeHtml(member.name)}</div>
                            <div class="member-email">${escapeHtml(member.email)}</div>
                        </div>
                    </li>
                `).join('');
            } catch (error) {
                membersList.innerHTML = '<li class="empty-state card">Error loading members</li>';
            }
        }

        async function handleAddMember() {
            const email = document.getElementById('memberEmailInput').value.trim();
            const successDiv = document.getElementById('memberSuccess');
            const errorDiv = document.getElementById('memberError');

            if (!email) {
                showError(errorDiv, 'Please enter an email address');
                return;
            }

            try {
                await addGroupMember(currentGroupId, email);
                document.getElementById('memberEmailInput').value = '';
                showSuccess(successDiv, 'Member invited successfully');
                loadMembers();
            } catch (error) {
                showError(errorDiv, error.message || 'Failed to add member');
            }
        }

        async function loadWatchlist() {
            if (!currentGroupId) return;
            try {
                const watchlist = normalizeCollection(await getWatchlist(currentGroupId));
                if (watchlist.length === 0) {
                    watchlistVotingGrid.innerHTML = '<div class="empty-state card"><h3>No movies in watchlist</h3><p>Add movies from Binge Bank to start voting.</p></div>';
                    return;
                }
                await displayWatchlistWithVoting(watchlist);
            } catch (error) {
                watchlistVotingGrid.innerHTML = '<div class="empty-state card"><h3>Error loading watchlist</h3></div>';
            }
        }

        async function displayWatchlistWithVoting(watchlist) {
            let html = '';
            for (const movie of watchlist) {
                const votes = normalizeCollection(await getMovieVotes(currentGroupId, movie.movie_id));
                const userVote = votes.find((v) => v.user_id === currentUser.id);
                const avg = votes.length > 0 ? (votes.reduce((sum, v) => sum + v.vote_value, 0) / votes.length).toFixed(1) : '0.0';

                html += `
                    <article class="watchlist-item card">
                        <div class="watchlist-poster">
                            ${movie.poster_url ? `<img src="${movie.poster_url}" alt="${escapeHtml(movie.title)}" loading="lazy">` : '<span>No Poster</span>'}
                        </div>
                        <div class="watchlist-info">
                            <div class="watchlist-title">${escapeHtml(movie.title)}</div>
                            <div class="watchlist-year">${movie.release_year || 'Unknown'}</div>
                            <div class="watchlist-meta">Added by ${escapeHtml(movie.added_by_name || 'Unknown')}</div>
                        </div>
                        <div class="voting-section">
                            <div class="voting-header">
                                <span class="voting-title">Rate this movie</span>
                                <span class="average-rating">${avg}/5</span>
                            </div>
                            <div class="star-rating" data-movie-id="${movie.movie_id}">
                                ${[1, 2, 3, 4, 5].map((rating) => `
                                    <span class="star ${userVote && userVote.vote_value >= rating ? 'active' : ''}" data-rating="${rating}" onclick="voteMovie(${movie.movie_id}, ${rating})">*</span>
                                `).join('')}
                            </div>
                            <div class="your-vote">${userVote ? `Your vote: ${userVote.vote_value}/5` : 'Click stars to vote'}</div>
                            <div class="vote-stats">
                                <div class="vote-count">${votes.length} vote${votes.length !== 1 ? 's' : ''}</div>
                                ${votes.length > 0 ? `<button class="btn btn-ghost" onclick="toggleVoteBreakdown(${movie.movie_id})" type="button">Breakdown</button>` : ''}
                            </div>
                            <div class="vote-breakdown" id="breakdown-${movie.movie_id}">${generateVoteBreakdown(votes)}</div>
                        </div>
                    </article>
                `;
            }

            watchlistVotingGrid.innerHTML = html;
            setupStarHoverEffects();
        }

        function generateVoteBreakdown(votes) {
            if (votes.length === 0) return '';
            const breakdown = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
            votes.forEach((vote) => { breakdown[vote.vote_value] += 1; });

            return [5, 4, 3, 2, 1].map((rating) => {
                const count = breakdown[rating];
                const percentage = votes.length > 0 ? (count / votes.length) * 100 : 0;
                return `
                    <div class="vote-bar">
                        <span>${rating}</span>
                        <div class="vote-bar-fill"><div class="vote-bar-progress" style="width:${percentage}%"></div></div>
                        <span>${count}</span>
                    </div>
                `;
            }).join('');
        }

        async function voteMovie(movieId, rating) {
            try {
                await voteOnMovie(currentGroupId, movieId, rating);
                await loadWatchlist();
                if (typeof showToast === 'function') showToast(`Voted ${rating}/5`, 'success');
            } catch (error) {
                if (typeof showToast === 'function') showToast(error.message || 'Failed to record vote', 'error');
            }
        }

        function setupStarHoverEffects() {
            document.querySelectorAll('.star-rating').forEach((ratingContainer) => {
                const stars = ratingContainer.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    star.addEventListener('mouseenter', () => {
                        stars.forEach((s, i) => s.classList.toggle('hover', i <= index));
                    });
                    star.addEventListener('mouseleave', () => {
                        stars.forEach((s) => s.classList.remove('hover'));
                    });
                });
            });
        }

        function toggleVoteBreakdown(movieId) {
            const breakdown = document.getElementById(`breakdown-${movieId}`);
            if (breakdown) breakdown.classList.toggle('show');
        }

        async function loadWatchlistMovies() {
            if (!currentGroupId) return;
            try {
                const watchlist = normalizeCollection(await getWatchlist(currentGroupId));
                const select = document.getElementById('chosenMovie');
                select.innerHTML = '<option value="">Select a movie from watchlist...</option>';
                watchlist.forEach((movie) => {
                    select.innerHTML += `<option value="${movie.movie_id}">${escapeHtml(movie.title)} (${movie.release_year || 'Unknown'})</option>`;
                });
            } catch (error) {
                console.error('Error loading watchlist for dropdown:', error);
            }
        }

        async function loadMovieNights() {
            if (!currentGroupId) return;
            try {
                const movieNights = normalizeCollection(await getMovieNights(currentGroupId));
                if (movieNights.length === 0) {
                    movieNightsList.innerHTML = '<li class="empty-state card">No movie nights scheduled yet</li>';
                    return;
                }

                movieNightsList.innerHTML = movieNights.map((night) => `
                    <li class="movie-night-item card">
                        <div class="movie-night-header">
                            <div class="movie-night-date">${formatDateTime(night.scheduled_date)}</div>
                            <div class="movie-night-status status-${night.status}">${night.status}</div>
                        </div>
                        <div class="movie-night-movie">${night.movie_title ? `Movie: ${escapeHtml(night.movie_title)}` : 'No movie selected yet'}</div>
                    </li>
                `).join('');
            } catch (error) {
                movieNightsList.innerHTML = '<li class="empty-state card">Error loading movie nights</li>';
            }
        }

        async function handleCreateMovieNight() {
            const dateInput = document.getElementById('movieNightDate').value;
            const movieSelect = document.getElementById('chosenMovie').value;
            const successDiv = document.getElementById('movieNightSuccess');
            const errorDiv = document.getElementById('movieNightError');

            if (!dateInput) {
                showError(errorDiv, 'Please select a date and time');
                return;
            }

            try {
                await createMovieNight(currentGroupId, dateInput, movieSelect || null);
                document.getElementById('movieNightDate').value = '';
                document.getElementById('chosenMovie').value = '';
                showSuccess(successDiv, 'Movie night scheduled');
                loadMovieNights();
            } catch (error) {
                showError(errorDiv, error.message || 'Failed to create movie night');
            }
        }

        function showError(element, message) {
            if (!element) return;
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => { element.style.display = 'none'; }, 5000);
            if (typeof showToast === 'function') showToast(message, 'error');
        }

        function showSuccess(element, message) {
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(() => { element.style.display = 'none'; }, 3000);
            }
            if (typeof showToast === 'function') showToast(message, 'success');
        }
    </script>
</body>
</html>
