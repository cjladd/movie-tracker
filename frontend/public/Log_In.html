<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Log in to WatchPartyHQ to plan movie nights with your friends.">
    <meta property="og:title" content="Log In - WatchPartyHQ">
    <meta property="og:description" content="Log in to WatchPartyHQ to plan movie nights with your friends.">
    <meta property="og:type" content="website">
    <link rel="canonical" href="Log_In.html">
    <title>Log In - WatchPartyHQ</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/pages/auth.css">
</head>
<body>
    <header class="header">
        <a href="website.html" class="logo-link" aria-label="WatchPartyHQ home">
            <h1 class="logo">WatchPartyHQ</h1>
        </a>
        <nav class="main-nav" aria-label="Main navigation">
            <a href="website.html">Home</a>
            <a href="Binge_Bank.html">Binge Bank</a>
            <a href="Stream_team.html">Stream Team</a>
            <a href="Friends.html">Friends</a>
            <a href="heads_up.html">Heads Up</a>
            <a href="Setting.html">Settings</a>
        </nav>
        <div class="nav-auth">
            <a href="Log_In.html" id="loginLink" class="nav-auth-btn nav-auth-ghost">Log In</a>
            <a href="Sign_Up.html" id="signUpLink" class="nav-auth-btn nav-auth-primary">Sign Up</a>
            <button type="button" id="logoutLink" class="nav-auth-btn nav-auth-primary" style="display:none;">Sign Out</button>
        </div>
    </header>

    <main class="auth-main">
        <section class="auth-card card animate-fade-in-up" data-animate>
            <h2>Welcome back</h2>
            <p class="auth-subtitle">Sign in and pick tonight's winner with your crew.</p>

            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>

            <form id="loginForm" novalidate>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required placeholder="you@example.com" autocomplete="email">
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="input-wrap">
                        <input type="password" id="password" name="password" required placeholder="Enter your password" autocomplete="current-password">
                        <button type="button" class="toggle-password" id="togglePassword" aria-label="Show password">Show</button>
                    </div>
                </div>

                <div class="forgot-password">
                    <a href="#" id="forgotPasswordLink">Forgot password?</a>
                </div>

                <div class="btn-row">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <span id="btnText">Log In</span>
                    </button>
                    <span class="loading-spinner" id="loading"></span>
                </div>
            </form>

            <div class="form-footer">
                Don't have an account? <a href="Sign_Up.html">Sign Up</a>
            </div>
        </section>
    </main>

    <script src="app.js"></script>
    <script>
        const form = document.getElementById('loginForm');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const passwordInput = document.getElementById('password');
        const togglePassword = document.getElementById('togglePassword');

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
            errorMessage.classList.add('animate-fade-in');
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        togglePassword.addEventListener('click', () => {
            const isHidden = passwordInput.type === 'password';
            passwordInput.type = isHidden ? 'text' : 'password';
            togglePassword.textContent = isHidden ? 'Hide' : 'Show';
            togglePassword.setAttribute('aria-label', isHidden ? 'Hide password' : 'Show password');
        });

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('registered') === 'true') {
            showSuccess('Registration successful. Please sign in.');
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessages();

            const email = document.getElementById('email').value.trim();
            const password = passwordInput.value;
            if (!email || !password) {
                showError('Please enter both email and password');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.classList.add('is-loading');
            btnText.textContent = 'Logging in...';
            loading.style.display = 'inline-block';

            try {
                await login(email, password);
                showSuccess('Login successful. Redirecting...');
            } catch (error) {
                showError(error.message || 'Invalid email or password');
            } finally {
                submitBtn.disabled = false;
                submitBtn.classList.remove('is-loading');
                btnText.textContent = 'Log In';
                loading.style.display = 'none';
            }
        });

        form.addEventListener('input', hideMessages);

        document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
            e.preventDefault();
            const email = prompt('Enter your account email for reset instructions:');
            if (!email || !email.trim()) return;

            fetch('/api/users/forgot-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email.trim() })
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.error) {
                        showError(data.error);
                    } else {
                        showSuccess('If that account exists, reset instructions have been generated.');
                        const resetUrl = data && data.data && data.data.resetUrl;
                        if (resetUrl) {
                            showSuccess(`Dev reset link: ${resetUrl}`);
                        }
                    }
                })
                .catch(() => {
                    showError('Unable to submit reset request. Try again shortly.');
                });
        });

        document.getElementById('email').focus();
    </script>
</body>
</html>
