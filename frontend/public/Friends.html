<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Friends - Manage your friends and send invites on WatchPartyHQ.">
  <meta property="og:title" content="Friends - WatchPartyHQ">
  <meta property="og:description" content="Manage your friends and send invites on WatchPartyHQ.">
  <meta property="og:type" content="website">
  <link rel="canonical" href="Friends.html">
  <title>Friends - WatchPartyHQ</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="css/pages/friends.css">
</head>
<body>
  <header class="header">
    <a href="website.html" class="logo-link" aria-label="WatchPartyHQ home">
      <h1 class="logo">WatchPartyHQ</h1>
    </a>
    <nav class="main-nav" aria-label="Main navigation">
      <a href="website.html">Home</a>
      <a href="Binge_Bank.html">Binge Bank</a>
      <a href="Stream_team.html">Stream Team</a>
      <a href="Friends.html">Friends</a>
      <a href="heads_up.html">Heads Up</a>
      <a href="Setting.html">Settings</a>
    </nav>
    <div class="nav-auth">
      <a href="Log_In.html" id="loginLink" class="nav-auth-btn nav-auth-ghost">Log In</a>
      <a href="Sign_Up.html" id="signUpLink" class="nav-auth-btn nav-auth-primary">Sign Up</a>
      <button type="button" id="logoutLink" class="nav-auth-btn nav-auth-primary" style="display:none;">Sign Out</button>
    </div>
  </header>

  <main class="fr-main">
    <section class="fr-header card" data-animate>
      <h2>Friends & Invites</h2>
      <p>Manage requests and keep your movie-night circle active.</p>
    </section>

    <section class="fr-request card" data-animate>
      <h3>Send Friend Request</h3>
      <div class="request-row">
        <label for="friendEmail" class="sr-only">Friend email address</label>
        <input type="email" id="friendEmail" placeholder="friend@example.com">
        <button id="sendRequestBtn" class="btn btn-primary" type="button">Send Request</button>
      </div>
      <div class="success-message" id="friendSuccess" style="display:none;" aria-live="polite"></div>
      <div class="error-message" id="friendError" style="display:none;" aria-live="assertive"></div>
    </section>

    <section class="fr-grid" data-animate>
      <div class="fr-panel card">
        <h3>Pending Requests</h3>
        <ul id="requestList" class="request-list"></ul>
      </div>

      <div class="fr-panel card">
        <h3>Your Friends</h3>
        <ul id="friendList" class="friend-list"></ul>
      </div>
    </section>
  </main>

  <script src="app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      loadFriends();
      loadRequests();
      document.getElementById('sendRequestBtn').addEventListener('click', handleSendRequest);
    });

    async function loadFriends() {
      const list = document.getElementById('friendList');
      try {
        const friends = normalizeCollection(await getFriends());
        if (friends.length === 0) {
          list.innerHTML = '<li class="card item-empty">You have no friends yet.</li>';
          return;
        }

        list.innerHTML = friends.map((f, index) => `
          <li class="friend-item card animate-fade-in-up stagger-${Math.min(index + 1, 8)}">
            <div class="friend-meta">
              <span class="friend-avatar">${escapeHtml((f.name || '?').charAt(0).toUpperCase())}</span>
              <div>
                <div class="friend-name">${escapeHtml(f.name)}</div>
                <div class="friend-email">${escapeHtml(f.email)}</div>
              </div>
            </div>
            <button class="btn btn-secondary" onclick="removeFriendHandler(${f.user_id})" type="button">Remove</button>
          </li>
        `).join('');
      } catch (err) {
        list.innerHTML = '<li class="card item-empty">Error loading friends.</li>';
      }
    }

    async function loadRequests() {
      const list = document.getElementById('requestList');
      try {
        const requests = normalizeCollection(await getFriendRequests());
        if (requests.length === 0) {
          list.innerHTML = '<li class="card item-empty">No pending requests.</li>';
          return;
        }

        list.innerHTML = requests.map((r, index) => `
          <li class="request-item card animate-fade-in-up stagger-${Math.min(index + 1, 8)}">
            <div class="friend-meta">
              <span class="friend-avatar incoming">${escapeHtml((r.sender_name || '?').charAt(0).toUpperCase())}</span>
              <div>
                <div class="friend-name">${escapeHtml(r.sender_name)}</div>
                <div class="friend-email">${escapeHtml(r.sender_email)}</div>
              </div>
            </div>
            <div class="request-actions">
              <button class="btn btn-primary" onclick="acceptRequestHandler(${r.request_id})" type="button">Accept</button>
              <button class="btn btn-danger" onclick="declineRequestHandler(${r.request_id})" type="button">Decline</button>
            </div>
          </li>
        `).join('');
      } catch (err) {
        list.innerHTML = '<li class="card item-empty">Error loading requests.</li>';
      }
    }

    async function handleSendRequest() {
      const email = document.getElementById('friendEmail').value.trim();
      const successDiv = document.getElementById('friendSuccess');
      const errorDiv = document.getElementById('friendError');

      if (!email) {
        setStatusMessage(successDiv, errorDiv, 'Please enter an email', 'error', 5000);
        return;
      }

      try {
        await sendFriendRequest(email);
        document.getElementById('friendEmail').value = '';
        setStatusMessage(successDiv, errorDiv, 'Request sent', 'success', 3000);
        loadRequests();
      } catch (err) {
        setStatusMessage(successDiv, errorDiv, getErrorMessage(err, 'Unable to send request'), 'error', 5000);
      }
    }

    async function acceptRequestHandler(requestId) {
      try {
        await acceptFriendRequest(requestId);
        if (typeof showToast === 'function') showToast('Request accepted', 'success');
        loadRequests();
        loadFriends();
      } catch (err) {
        if (typeof showToast === 'function') showToast(getErrorMessage(err, 'Unable to accept request'), 'error');
      }
    }

    async function declineRequestHandler(requestId) {
      try {
        await declineFriendRequest(requestId);
        if (typeof showToast === 'function') showToast('Request declined', 'info');
        loadRequests();
      } catch (err) {
        if (typeof showToast === 'function') showToast(getErrorMessage(err, 'Unable to decline request'), 'error');
      }
    }

    async function removeFriendHandler(friendId) {
      if (!confirm('Remove this friend?')) return;
      try {
        await removeFriend(friendId);
        if (typeof showToast === 'function') showToast('Friend removed', 'warning');
        loadFriends();
      } catch (err) {
        if (typeof showToast === 'function') showToast(getErrorMessage(err, 'Unable to remove friend'), 'error');
      }
    }
  </script>
</body>
</html>
