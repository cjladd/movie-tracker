<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Heads Up - Notifications, movie night countdowns, and schedule updates for MovieNightPlanner.">
    <meta property="og:title" content="Heads Up - MovieNightPlanner">
    <meta property="og:description" content="Notifications, movie night countdowns, and schedule updates.">
    <meta property="og:type" content="website">
    <link rel="canonical" href="heads_up.html">
    <title>Heads Up - MovieNightPlanner</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/pages/heads-up.css">
</head>
<body>
    <header class="header">
        <a href="website.html" class="logo-link" aria-label="MovieNightPlanner home">
            <h1 class="logo">MovieNightPlanner</h1>
        </a>
        <nav class="main-nav" aria-label="Main navigation">
            <a href="website.html">Home</a>
            <a href="Binge_Bank.html">Binge Bank</a>
            <a href="Stream_team.html">Stream Team</a>
            <a href="Friends.html">Friends</a>
            <a href="heads_up.html">Heads Up</a>
            <a href="Setting.html">Settings</a>
        </nav>
        <div class="nav-auth">
            <a href="Log_In.html" id="loginLink" class="nav-auth-btn nav-auth-ghost">Log In</a>
            <a href="Sign_Up.html" id="signUpLink" class="nav-auth-btn nav-auth-primary">Sign Up</a>
            <button type="button" id="logoutLink" class="nav-auth-btn nav-auth-primary" style="display:none;">Sign Out</button>
        </div>
    </header>

    <main class="hu-main">
        <section class="hu-header card" data-animate>
            <div class="title-wrap">
                <h2>Heads Up</h2>
                <span class="notification-count" id="unreadCount" style="display:none;">0</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" id="refreshBtn" type="button">Refresh</button>
                <button class="btn btn-ghost" id="markAllRead" type="button" style="display:none;">Mark all as read</button>
            </div>
        </section>

        <section class="status-messages" data-animate>
            <div class="success-message" id="successMessage" aria-live="polite"></div>
            <div class="error-message" id="errorMessage" aria-live="assertive"></div>
        </section>

        <section class="upcoming-wrap" data-animate>
            <div class="section-head">
                <h3>Upcoming Movie Nights</h3>
                <p>Countdown to your next plans.</p>
            </div>
            <div id="upcomingContainer" class="upcoming-grid"></div>
        </section>

        <section class="notifications-wrap" data-animate>
            <div id="content"></div>
        </section>
    </main>

    <script src="app.js"></script>
    <script>
        let notifications = [];
        let currentFilter = 'all';
        let unreadCountFromServer = null;

        const content = document.getElementById('content');
        const unreadCount = document.getElementById('unreadCount');
        const markAllRead = document.getElementById('markAllRead');
        const refreshBtn = document.getElementById('refreshBtn');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const upcomingContainer = document.getElementById('upcomingContainer');

        document.addEventListener('DOMContentLoaded', async () => {
            await ensureAuthState();
            loadAllData();
            setupEventListeners();
            setInterval(loadAllData, 30000);
        });

        function normalizeNotification(raw) {
            return {
                id: raw.id || raw.notification_id,
                title: raw.title || 'Notification',
                message: raw.message || '',
                type: raw.type || 'update',
                created_at: raw.created_at,
                read: typeof raw.read === 'boolean' ? raw.read : !!raw.is_read
            };
        }

        function setupEventListeners() {
            markAllRead.addEventListener('click', handleMarkAllAsRead);
            refreshBtn.addEventListener('click', loadAllData);
        }

        async function loadAllData() {
            await Promise.all([loadNotifications(true), loadUpcomingMovieNights()]);
        }

        async function loadNotifications(showLoading = false) {
            if (!currentUser) {
                renderStandardState(
                    content,
                    'empty',
                    'Please log in to view notifications',
                    'Get updates about movie nights, group invites, and votes.'
                );
                return;
            }

            if (showLoading) {
                renderStandardState(content, 'loading');
            }

            try {
                const apiResult = await getNotifications({ page: 1, limit: 100 });
                notifications = normalizeCollection(apiResult).map(normalizeNotification);
                displayNotifications();
                await refreshUnreadCount();
                updateNotificationCount();
            } catch (error) {
                showError(getErrorMessage(error, 'Failed to load notifications. Please try again.'));
                renderStandardState(content, 'error', 'Error loading notifications', 'Please check your connection and refresh.');
            }
        }

        async function loadUpcomingMovieNights() {
            if (!currentUser) {
                renderStandardState(upcomingContainer, 'empty', 'Log in to see your upcoming nights');
                return;
            }

            try {
                const groups = normalizeCollection(await getGroups());
                const allNights = [];

                for (const group of groups.slice(0, 8)) {
                    const nights = normalizeCollection(await getMovieNights(group.group_id));
                    nights.forEach((night) => {
                        if (night.status === 'planned') {
                            allNights.push({ ...night, group_name: group.group_name });
                        }
                    });
                }

                allNights.sort((a, b) => new Date(a.scheduled_date) - new Date(b.scheduled_date));
                const upcoming = allNights.slice(0, 6);

                if (upcoming.length === 0) {
                    renderStandardState(upcomingContainer, 'empty', 'No upcoming movie nights scheduled yet');
                    return;
                }

                upcomingContainer.innerHTML = upcoming.map((night) => {
                    const target = new Date(night.scheduled_date);
                    const countdown = getCountdown(target);
                    return `
                        <article class="upcoming-card card">
                            <div class="upcoming-top">
                                <h4>${escapeHtml(night.group_name)}</h4>
                                <span class="night-status">Planned</span>
                            </div>
                            <p class="upcoming-date">${formatDateTime(night.scheduled_date)}</p>
                            <p class="upcoming-movie">${night.movie_title ? `Movie: ${escapeHtml(night.movie_title)}` : 'Movie: TBD'}</p>
                            <div class="countdown-grid">
                                <div><strong>${countdown.days}</strong><span>days</span></div>
                                <div><strong>${countdown.hours}</strong><span>hours</span></div>
                                <div><strong>${countdown.minutes}</strong><span>mins</span></div>
                            </div>
                        </article>
                    `;
                }).join('');
            } catch (error) {
                renderStandardState(upcomingContainer, 'error', 'Could not load upcoming nights');
            }
        }

        function getCountdown(target) {
            const now = new Date();
            const diff = Math.max(0, target - now);
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
            const minutes = Math.floor((diff / (1000 * 60)) % 60);
            return { days, hours, minutes };
        }

        function displayNotifications() {
            if (notifications.length === 0) {
                content.innerHTML = createFiltersHTML() + '<div class="empty-state card"><h3>No notifications yet</h3><p>You are all caught up.</p></div>';
                return;
            }

            const filtered = filterNotifications(notifications, currentFilter);
            const filtersHTML = createFiltersHTML();
            const notificationsHTML = createNotificationsHTML(filtered);

            content.innerHTML = filtersHTML + notificationsHTML;
            setupFilterListeners();
        }

        function createFiltersHTML() {
            const filters = [
                { key: 'all', label: 'All' },
                { key: 'unread', label: 'Unread' },
                { key: 'group_invite', label: 'Invites' },
                { key: 'movie_night', label: 'Movie Nights' },
                { key: 'vote_reminder', label: 'Votes' }
            ];

            return `
                <div class="notifications-filters">
                    ${filters.map((filter) => `
                        <button class="filter-chip ${currentFilter === filter.key ? 'active' : ''}" data-filter="${filter.key}" type="button">${filter.label}</button>
                    `).join('')}
                </div>
            `;
        }

        function createNotificationsHTML(filteredNotifications) {
            if (filteredNotifications.length === 0) {
                return '<div class="empty-state card"><h3>No notifications for this filter</h3></div>';
            }

            return `
                <ul class="notifications-list">
                    ${filteredNotifications.map((notification) => `
                        <li class="notification-card card ${notification.read ? 'read' : 'unread'}" data-id="${notification.id}">
                            <div class="notification-type-badge type-${notification.type}">${notification.type.replace('_', ' ')}</div>
                            <div class="notification-header">
                                <h4 class="notification-title">${escapeHtml(notification.title)}</h4>
                                <div class="notification-time">${getTimeAgo(notification.created_at)}</div>
                            </div>
                            <div class="notification-body">${escapeHtml(notification.message)}</div>
                            <div class="notification-actions">${createActionButtons(notification)}</div>
                        </li>
                    `).join('')}
                </ul>
            `;
        }

        function createActionButtons(notification) {
            const buttons = [];

            if (notification.type === 'group_invite') {
                buttons.push(`<button class="btn btn-primary" onclick="acceptInvite(${notification.id})" type="button">Accept</button>`);
                buttons.push(`<button class="btn btn-danger" onclick="declineInvite(${notification.id})" type="button">Decline</button>`);
            }

            if (notification.type === 'movie_night') {
                buttons.push(`<button class="btn btn-secondary" onclick="viewMovieNight(${notification.id})" type="button">Open Group</button>`);
            }

            if (notification.type === 'vote_reminder') {
                buttons.push(`<button class="btn btn-secondary" onclick="goToVote(${notification.id})" type="button">Go to Vote</button>`);
            }

            if (!notification.read) {
                buttons.push(`<button class="btn btn-ghost" onclick="markAsRead(${notification.id})" type="button">Mark as Read</button>`);
            }

            return buttons.join('');
        }

        function setupFilterListeners() {
            document.querySelectorAll('.filter-chip').forEach((chip) => {
                chip.addEventListener('click', () => {
                    currentFilter = chip.dataset.filter;
                    displayNotifications();
                });
            });
        }

        function filterNotifications(items, filter) {
            if (filter === 'unread') return items.filter((n) => !n.read);
            if (filter === 'all') return items;
            return items.filter((n) => n.type === filter);
        }

        function updateNotificationCount() {
            const localUnreadCount = notifications.filter((n) => !n.read).length;
            const count = Number.isInteger(unreadCountFromServer) ? unreadCountFromServer : localUnreadCount;

            if (count > 0) {
                unreadCount.textContent = count;
                unreadCount.style.display = 'inline-flex';
                markAllRead.style.display = 'inline-flex';
            } else {
                unreadCount.style.display = 'none';
                markAllRead.style.display = 'none';
            }

            document.title = count > 0 ? `(${count}) Heads Up - MovieNightPlanner` : 'Heads Up - MovieNightPlanner';
        }

        async function refreshUnreadCount() {
            try {
                unreadCountFromServer = await getUnreadNotificationsCount();
            } catch (_error) {
                unreadCountFromServer = null;
            }
        }

        async function markAsRead(notificationId) {
            try {
                await markNotificationAsRead(notificationId);
                const notification = notifications.find((n) => n.id === notificationId);
                if (notification && !notification.read) {
                    notification.read = true;
                    if (Number.isInteger(unreadCountFromServer)) {
                        unreadCountFromServer = Math.max(0, unreadCountFromServer - 1);
                    }
                }
                displayNotifications();
                updateNotificationCount();
                showSuccess('Notification marked as read');
            } catch (error) {
                showError(getErrorMessage(error, 'Failed to mark notification as read'));
            }
        }

        async function handleMarkAllAsRead() {
            try {
                await markAllNotificationsAsRead();
                notifications.forEach((n) => { n.read = true; });
                unreadCountFromServer = 0;
                displayNotifications();
                updateNotificationCount();
                showSuccess('All notifications marked as read');
            } catch (error) {
                showError(getErrorMessage(error, 'Failed to mark all notifications as read'));
            }
        }

        function acceptInvite(notificationId) {
            markAsRead(notificationId);
            showSuccess('Group invitation accepted');
        }

        function declineInvite(notificationId) {
            markAsRead(notificationId);
            showSuccess('Group invitation declined');
        }

        function viewMovieNight(notificationId) {
            markAsRead(notificationId);
            window.location.href = 'Stream_team.html';
        }

        function goToVote(notificationId) {
            markAsRead(notificationId);
            window.location.href = 'Stream_team.html';
        }

        function showSuccess(message) {
            setStatusMessage(successMessage, errorMessage, message, 'success', 3000);
        }

        function showError(message) {
            setStatusMessage(successMessage, errorMessage, message, 'error', 5000);
        }
    </script>
</body>
</html>
